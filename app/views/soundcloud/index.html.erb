<div id="container" ng-app="SelmaApp">
  <!-- SOUNDCLOUD IFRAME -->
  <iframe id="sc-widget" src=<%= "https://w.soundcloud.com/player/?url=https://api.soundcloud.com/tracks/190913112?client_id=#{ENV['SOUNDCLOUD_CLIENT_ID']}" %> width="500" height="170" scrolling="no" frameborder="no"></iframe>

  <div id="content-wrapper" ng-controller="patchController">

      <!-- Question squares -->
    <div id="questions" class="hidden">
      <p>Which color do you imagine?</p>
      <div id="square-1" class="square" ng-click="addSquareColor('#AEE5F1')"></div>
      <div id="square-2" class="square" ng-click="addSquareColor('#F25239')"></div>
      <div id="square-3" class="square" ng-click="addSquareColor('#B3BCBF')"></div>
      <div id="square-4" class="square" ng-click="addSquareColor('#FEBBCD')"></div>
    </div>

    <!-- Dream patch squares. Hidden by default -->
    <div id="dream-patch">
      <div ng-repeat="square in squares" id="answer-square-{{$index}}" class="answer-square"></div>
    </div>

    <button id='save' class="hidden">save</button>
    <div id='img-out'></div>

    <div id="quilt" >
    </div>

  </div><!-- Closes content-wrapper -->

</div><!-- Closes container  -->


<script type="text/javascript">

  $(function() { 
    var theCanvas
      $("#save").click(function() { 
          html2canvas($("#dream-patch"), {
              onrendered: function(canvas) {
                  theCanvas = canvas;
                  document.body.appendChild(canvas);
                  $("#img-out").append(canvas);
                  Canvas2Image.saveAsPNG(theCanvas);
                  // Clean up 
                  //document.body.removeChild(canvas);
              }
          })
      })
  }); 

  // Sets Soundcloud iframe as a player controllable by js. Also sets global variables.
  var widgetIframe = document.getElementById('sc-widget'),
      widget = SC.Widget(widgetIframe),
      clickCount = -0.5,
      track_position = "";

  // Hides question square after user clicks a square
  $('.square').click(function(){
    $('#questions').addClass('hidden');
    clickCount += 0.5;
  })



  // logs the position of the track in milliseconds
  function position(){
  	widget.getPosition(function(positionSC){
  		console.log(Math.round(positionSC));
  	});
  }

  // Listens to the track position and prompts the user with a new question ever 3 seconds
  widget.bind(SC.Widget.Events.PLAY_PROGRESS, function(eventData) {
    track_position = JSON.stringify(eventData.currentPosition);
    track_position = Math.floor(track_position/100);
    // console.log(track_position);
    if (track_position % 30 == 0 && track_position > 0){
      $('#questions').removeClass('hidden');
    };
  });

</script>